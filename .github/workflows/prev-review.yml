name: prev-review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: prev-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    if: github.event.pull_request.draft == false && contains(github.event.pull_request.labels.*.name, 'review')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Configure prev
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          mkdir -p "$HOME/.config/prev"
          cp ci/prev-config-github.yml "$HOME/.config/prev/config.yml"
          go run . config validate

      - name: Review pull request with prev
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "OPENAI_API_KEY is not configured. Skipping prev review."
            exit 0
          fi
          go run . mr review "${{ github.repository }}" "${{ github.event.pull_request.number }}" \
            --vcs github \
            --strictness normal \
            --max-comments 15
